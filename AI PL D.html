<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriScan AI - Advanced Plant Disease Detection</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary: #ff9800;
            --text: #333;
            --text-light: #666;
            --background: #f9f9f9;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text);
            background-color: var(--background);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background-color: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }
        
        .nav-links {
            display: flex;
            gap: 30px;
        }
        
        .nav-links a {
            text-decoration: none;
            color: var(--text);
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .nav-links a:hover {
            color: var(--primary);
        }
        
        .hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            padding: 80px 0;
            text-align: center;
        }
        
        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        
        .hero p {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto 30px;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: var(--white);
            padding: 12px 30px;
            border-radius: var(--radius);
            text-decoration: none;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background-color: #e68900;
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--white);
        }
        
        .btn-outline:hover {
            background-color: var(--white);
            color: var(--primary);
        }
        
        .btn-secondary {
            background-color: var(--primary);
        }
        
        .btn-secondary:hover {
            background-color: var(--primary-dark);
        }
        
        .section {
            padding: 80px 0;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .section-title h2 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .section-title p {
            color: var(--text-light);
            max-width: 600px;
            margin: 0 auto;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .feature-card {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .feature-card h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .upload-area {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--shadow);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upload-box {
            border: 2px dashed #ddd;
            border-radius: var(--radius);
            padding: 40px 20px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-box:hover {
            border-color: var(--primary);
        }
        
        .upload-box i {
            font-size: 3rem;
            color: var(--primary-light);
            margin-bottom: 15px;
        }
        
        .upload-box p {
            margin-bottom: 15px;
        }
        
        .preview-container {
            display: none;
            margin-top: 30px;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        
        .results {
            display: none;
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-top: 30px;
        }
        
        .disease-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .confidence-meter {
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background-color: var(--primary);
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .treatment-card {
            background-color: #f5f5f5;
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 15px;
        }
        
        .history-chart {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-top: 30px;
        }
        
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .chatbot-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chatbot-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
        }
        
        .bot-message {
            background: #f1f1f1;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .user-message {
            background: var(--primary-light);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .chatbot-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        .chatbot-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .chatbot-input button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            cursor: pointer;
        }
        
        .chatbot-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 999;
        }
        
        .chatbot-hidden {
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .advanced-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .advanced-feature {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .advanced-feature h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .camera-container {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        
        #cameraFeed {
            max-width: 100%;
            border-radius: var(--radius);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        footer {
            background-color: var(--primary-dark);
            color: var(--white);
            padding: 50px 0 20px;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .footer-column h3 {
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .footer-column ul {
            list-style: none;
        }
        
        .footer-column ul li {
            margin-bottom: 10px;
        }
        
        .footer-column a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-column a:hover {
            color: var(--white);
        }
        
        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: #ccc;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                gap: 15px;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .disease-info {
                grid-template-columns: 1fr;
            }
            
            .chatbot-container {
                width: 100%;
                height: 100%;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <span class="logo-icon">üå±</span>
                    <span>AgriScan AI</span>
                </div>
                <div class="nav-links">
                    <a href="#home">Home</a>
                    <a href="#detect">Detect</a>
                    <a href="#history">History</a>
                    <a href="#about">About</a>
                </div>
            </nav>
        </div>
    </header>

    <section class="hero" id="home">
        <div class="container">
            <h1>Advanced AI Plant Disease Detection</h1>
            <p>Identify plant diseases early with our cutting-edge AI technology. Upload a photo of your plant leaves and get instant diagnosis with treatment recommendations.</p>
            <a href="#detect" class="btn">Get Started</a>
            <a href="#about" class="btn btn-outline">Learn More</a>
        </div>
    </section>

    <section class="section" id="detect">
        <div class="container">
            <div class="section-title">
                <h2>Plant Disease Detection</h2>
                <p>Upload an image of your plant leaves for instant AI-powered analysis</p>
            </div>
            
            <div class="upload-area">
                <h3>Upload Plant Image</h3>
                <div class="upload-box" id="uploadBox">
                    <i>üì∑</i>
                    <p>Drag & drop your image here or click to browse</p>
                    <span>Supported formats: JPG, PNG, JPEG (Max 5MB)</span>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                
                <div class="camera-container" id="cameraContainer">
                    <video id="cameraFeed" autoplay playsinline></video>
                    <div class="action-buttons">
                        <button class="btn" id="captureBtn">Capture Image</button>
                        <button class="btn btn-secondary" id="switchCameraBtn">Switch Camera</button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn" id="cameraToggleBtn">Use Camera</button>
                    <button class="btn btn-secondary" id="scanQRBtn">Scan Plant QR Code</button>
                </div>
                
                <div class="preview-container" id="previewContainer">
                    <img src="" alt="Preview" class="preview-image" id="previewImage">
                    <button class="btn" id="analyzeBtn">Analyze Image</button>
                </div>
            </div>
            
            <div class="loading" id="loadingIndicator">
                <div class="loading-spinner"></div>
                <p>Analyzing image with AI...</p>
            </div>
            
            <div class="results" id="results">
                <h3>Analysis Results</h3>
                <div class="disease-info">
                    <div>
                        <h4>Detected Disease</h4>
                        <p id="diseaseName">Loading...</p>
                        
                        <h4>Confidence Level</h4>
                        <div class="confidence-meter">
                            <div class="confidence-fill" id="confidenceFill"></div>
                        </div>
                        <p id="confidenceText">0%</p>
                        
                        <h4>Plant Species</h4>
                        <p id="plantSpecies">Loading...</p>
                        
                        <h4>Severity</h4>
                        <p id="severityLevel">Loading...</p>
                    </div>
                    <div>
                        <h4>Recommended Treatment</h4>
                        <div class="treatment-card" id="treatmentInfo">
                            <p>Treatment information will appear here after analysis.</p>
                        </div>
                        
                        <h4>Prevention Tips</h4>
                        <div class="treatment-card" id="preventionInfo">
                            <p>Prevention tips will appear here after analysis.</p>
                        </div>
                        
                        <h4>Environmental Impact</h4>
                        <div class="treatment-card" id="environmentalInfo">
                            <p>Environmental impact information will appear here after analysis.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="advanced-features">
                <div class="advanced-feature">
                    <h4>Weather Integration</h4>
                    <p>Get localized weather data for disease prediction</p>
                    <button class="btn" id="weatherBtn">Check Weather</button>
                </div>
                <div class="advanced-feature">
                    <h4>Market Prices</h4>
                    <p>Check current market prices for affected crops</p>
                    <button class="btn" id="marketBtn">View Prices</button>
                </div>
                <div class="advanced-feature">
                    <h4>Export Report</h4>
                    <p>Download detailed analysis report</p>
                    <button class="btn" id="exportBtn">Export PDF</button>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="features">
        <div class="container">
            <div class="section-title">
                <h2>Advanced AI Features</h2>
                <p>Our system uses cutting-edge technology to provide accurate plant disease detection</p>
            </div>
            
            <div class="features">
                <div class="feature-card">
                    <div class="feature-icon">üîç</div>
                    <h3>Multi-Disease Detection</h3>
                    <p>Identify multiple plant diseases from a single image with high accuracy using our advanced AI models.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üåø</div>
                    <h3>Multi-Plant Support</h3>
                    <p>Our system recognizes diseases across various plant species including tomatoes, potatoes, corn, and more.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üíä</div>
                    <h3>Treatment Recommendations</h3>
                    <p>Get personalized treatment plans and prevention strategies based on the detected disease.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>Historical Analysis</h3>
                    <p>Track disease patterns over time with detailed analytics and visualizations.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ü§ñ</div>
                    <h3>AI Chat Assistant</h3>
                    <p>Get instant answers to your plant health questions with our AI-powered chatbot.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üåê</div>
                    <h3>Real-time Processing</h3>
                    <p>Get instant results with our optimized AI models that process images in real-time.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="history">
        <div class="container">
            <div class="section-title">
                <h2>Disease History & Analytics</h2>
                <p>Track and analyze plant health over time with our comprehensive dashboard</p>
            </div>
            
            <div class="history-chart">
                <canvas id="diseaseChart"></canvas>
            </div>
        </div>
    </section>

    <!-- AI Chatbot -->
    <div class="chatbot-toggle" id="chatbotToggle">
        <span>ü§ñ</span>
    </div>
    
    <div class="chatbot-container chatbot-hidden" id="chatbotContainer">
        <div class="chatbot-header">
            <h3>AgriScan AI Assistant</h3>
            <button id="closeChatbot" style="background: none; border: none; color: white; font-size: 1.2rem;">√ó</button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="message bot-message">
                Hello! I'm your plant health assistant. How can I help you today?
            </div>
        </div>
        <div class="chatbot-input">
            <input type="text" id="chatbotInput" placeholder="Ask about plant diseases...">
            <button id="sendMessage">‚û§</button>
        </div>
    </div>

    <footer id="about">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>AgriScan AI</h3>
                    <p>Advanced AI-powered plant disease detection system designed to help farmers protect their crops.</p>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#home">Home</a></li>
                        <li><a href="#detect">Disease Detection</a></li>
                        <li><a href="#history">Analytics</a></li>
                        <li><a href="#about">About Us</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Resources</h3>
                    <ul>
                        <li><a href="#">Plant Disease Database</a></li>
                        <li><a href="#">Treatment Guides</a></li>
                        <li><a href="#">Research Papers</a></li>
                        <li><a href="#">API Documentation</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contact Us</h3>
                    <ul>
                        <li>Email: info@agriscan.ai</li>
                        <li>Phone: +1 (555) 123-4567</li>
                        <li>Address: 123 Farm Tech Lane, Agriculture City</li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2023 AgriScan AI. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // DOM Elements
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const results = document.getElementById('results');
        const diseaseName = document.getElementById('diseaseName');
        const confidenceFill = document.getElementById('confidenceFill');
        const confidenceText = document.getElementById('confidenceText');
        const plantSpecies = document.getElementById('plantSpecies');
        const treatmentInfo = document.getElementById('treatmentInfo');
        const preventionInfo = document.getElementById('preventionInfo');
        const severityLevel = document.getElementById('severityLevel');
        const environmentalInfo = document.getElementById('environmentalInfo');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // Camera elements
        const cameraContainer = document.getElementById('cameraContainer');
        const cameraToggleBtn = document.getElementById('cameraToggleBtn');
        const cameraFeed = document.getElementById('cameraFeed');
        const captureBtn = document.getElementById('captureBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const scanQRBtn = document.getElementById('scanQRBtn');
        
        // Advanced feature buttons
        const weatherBtn = document.getElementById('weatherBtn');
        const marketBtn = document.getElementById('marketBtn');
        const exportBtn = document.getElementById('exportBtn');
        
        // Chatbot elements
        const chatbotToggle = document.getElementById('chatbotToggle');
        const chatbotContainer = document.getElementById('chatbotContainer');
        const closeChatbot = document.getElementById('closeChatbot');
        const chatbotMessages = document.getElementById('chatbotMessages');
        const chatbotInput = document.getElementById('chatbotInput');
        const sendMessageBtn = document.getElementById('sendMessage');

        // Global variables
        let currentStream = null;
        let isUsingFrontCamera = false;
        let detectionHistory = JSON.parse(localStorage.getItem('detectionHistory')) || [];
        let plantNetModel = null;

        // Event Listeners
        uploadBox.addEventListener('click', () => fileInput.click());
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.style.borderColor = 'var(--primary)';
            uploadBox.style.backgroundColor = 'rgba(46, 125, 50, 0.05)';
        });
        uploadBox.addEventListener('dragleave', () => {
            uploadBox.style.borderColor = '#ddd';
            uploadBox.style.backgroundColor = 'transparent';
        });
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.style.borderColor = '#ddd';
            uploadBox.style.backgroundColor = 'transparent';
            
            if (e.dataTransfer.files.length) {
                handleImageUpload(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleImageUpload(e.target.files[0]);
            }
        });

        analyzeBtn.addEventListener('click', analyzeImage);
        
        // Camera event listeners
        cameraToggleBtn.addEventListener('click', toggleCamera);
        captureBtn.addEventListener('click', captureImage);
        switchCameraBtn.addEventListener('click', switchCamera);
        scanQRBtn.addEventListener('click', scanQRCode);
        
        // Advanced feature event listeners
        weatherBtn.addEventListener('click', getWeatherData);
        marketBtn.addEventListener('click', getMarketPrices);
        exportBtn.addEventListener('click', exportReport);
        
        // Chatbot event listeners
        chatbotToggle.addEventListener('click', toggleChatbot);
        closeChatbot.addEventListener('click', toggleChatbot);
        sendMessageBtn.addEventListener('click', sendChatMessage);
        chatbotInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        // Functions
        function handleImageUpload(file) {
            if (!file.type.match('image.*')) {
                alert('Please upload an image file');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
                results.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // Camera functions
        async function toggleCamera() {
            if (currentStream) {
                stopCamera();
                cameraContainer.style.display = 'none';
                cameraToggleBtn.textContent = 'Use Camera';
            } else {
                try {
                    await startCamera();
                    cameraContainer.style.display = 'block';
                    cameraToggleBtn.textContent = 'Stop Camera';
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    alert('Unable to access camera. Please check permissions.');
                }
            }
        }

        async function startCamera() {
            const constraints = {
                video: { 
                    facingMode: isUsingFrontCamera ? 'user' : 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraFeed.srcObject = currentStream;
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = cameraFeed.videoWidth;
            canvas.height = cameraFeed.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
            
            previewImage.src = canvas.toDataURL('image/png');
            previewContainer.style.display = 'block';
            results.style.display = 'none';
            
            stopCamera();
            cameraContainer.style.display = 'none';
            cameraToggleBtn.textContent = 'Use Camera';
        }

        function switchCamera() {
            isUsingFrontCamera = !isUsingFrontCamera;
            if (currentStream) {
                stopCamera();
                startCamera();
            }
        }

        function scanQRCode() {
            alert('QR code scanning feature would be implemented with a QR library in a production app');
        }

        // AI Model Integration
        async function loadPlantNetModel() {
            // In a real implementation, you would load a trained model
            // For this example, we'll use MobileNet for demonstration
            try {
                console.log("Loading AI model...");
                const model = await tf.loadGraphModel('https://tfhub.dev/google/tfjs-model/aiy/vision/classifier/plants_V1/1', {fromTFHub: true});
                console.log("AI model loaded successfully");
                return model;
            } catch (error) {
                console.error("Error loading model, using fallback:", error);
                // Fallback to MobileNet
                return await mobilenet.load();
            }
        }

        async function analyzeImage() {
            if (!previewImage.src) {
                alert('Please upload an image first');
                return;
            }
            
            // Show loading state
            loadingIndicator.style.display = 'block';
            results.style.display = 'none';
            
            diseaseName.textContent = 'Analyzing...';
            confidenceText.textContent = '0%';
            confidenceFill.style.width = '0%';
            plantSpecies.textContent = 'Identifying...';
            severityLevel.textContent = 'Analyzing...';
            treatmentInfo.innerHTML = '<p>Analyzing image for treatment recommendations...</p>';
            preventionInfo.innerHTML = '<p>Analyzing image for prevention tips...</p>';
            environmentalInfo.innerHTML = '<p>Analyzing environmental impact...</p>';
            
            try {
                // Load model if not already loaded
                if (!plantNetModel) {
                    plantNetModel = await loadPlantNetModel();
                }
                
                // Perform AI prediction
                const predictions = await predictDisease(previewImage);
                
                // Get disease info from online API
                const diseaseInfo = await fetchDiseaseInfo(predictions.plant, predictions.disease);
                
                // Update UI with results
                updateResultsUI(diseaseInfo, predictions.confidence);
                
                // Add to history
                addToHistory(diseaseInfo, predictions.confidence);
                
            } catch (error) {
                console.error('Error during analysis:', error);
                diseaseName.textContent = 'Analysis Failed';
                confidenceText.textContent = '0%';
                confidenceFill.style.width = '0%';
                plantSpecies.textContent = 'Unknown';
                severityLevel.textContent = 'Unknown';
                treatmentInfo.innerHTML = '<p>Unable to analyze image. Please try again.</p>';
                preventionInfo.innerHTML = '<p>Unable to provide prevention tips.</p>';
                environmentalInfo.innerHTML = '<p>Unable to analyze environmental impact.</p>';
            } finally {
                loadingIndicator.style.display = 'none';
                results.style.display = 'block';
            }
        }

        async function predictDisease(imageElement) {
            // In a real implementation, this would use the actual model
            // For this demo, we'll simulate prediction with realistic data
            
            // Simulate processing time
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Mock prediction results
            const plants = ['Tomato', 'Potato', 'Corn', 'Wheat', 'Rice', 'Apple', 'Grape'];
            const diseases = [
                'Early Blight', 'Late Blight', 'Powdery Mildew', 'Leaf Spot', 
                'Rust', 'Blight', 'Mosaic Virus', 'Healthy'
            ];
            
            const randomPlant = plants[Math.floor(Math.random() * plants.length)];
            const randomDisease = diseases[Math.floor(Math.random() * diseases.length)];
            const confidence = Math.random() * 30 + 70; // 70-100% confidence
            
            return {
                plant: randomPlant,
                disease: randomDisease,
                confidence: confidence
            };
        }

        async function fetchDiseaseInfo(plant, disease) {
            // In a real implementation, this would fetch from a plant disease API
            // For this demo, we'll use mock data
            
            const treatments = {
                'Early Blight': 'Apply copper-based fungicides every 7-10 days. Remove infected leaves to prevent spread.',
                'Late Blight': 'Apply fungicides containing chlorothalonil or mancozeb. Remove and destroy infected plants immediately.',
                'Powdery Mildew': 'Apply sulfur or potassium bicarbonate-based fungicides. Improve air circulation.',
                'Leaf Spot': 'Remove affected leaves. Apply copper-based fungicides. Avoid overhead watering.',
                'Rust': 'Apply fungicides containing myclobutanil or tebuconazole. Remove infected plants.',
                'Blight': 'Remove and destroy infected plants. Apply appropriate fungicides. Rotate crops.',
                'Mosaic Virus': 'Remove infected plants. Control aphid populations. Use virus-free seeds.',
                'Healthy': 'No treatment needed. Continue regular plant care and monitoring.'
            };
            
            const preventions = {
                'Early Blight': 'Rotate crops annually. Water at the base of plants. Use resistant varieties.',
                'Late Blight': 'Avoid overhead watering. Ensure good air circulation. Use certified disease-free seeds.',
                'Powdery Mildew': 'Plant in sunny locations. Space plants properly. Water in the morning.',
                'Leaf Spot': 'Avoid overhead irrigation. Clean garden debris. Use drip irrigation.',
                'Rust': 'Plant resistant varieties. Space plants properly. Remove weed hosts.',
                'Blight': 'Use disease-free seeds. Rotate crops. Avoid working in wet plants.',
                'Mosaic Virus': 'Control insect vectors. Use virus-free seeds. Remove weed hosts.',
                'Healthy': 'Maintain proper watering, nutrition, and monitoring practices.'
            };
            
            const severities = {
                'Early Blight': 'Moderate',
                'Late Blight': 'High',
                'Powdery Mildew': 'Low to Moderate',
                'Leaf Spot': 'Low',
                'Rust': 'Moderate',
                'Blight': 'High',
                'Mosaic Virus': 'High',
                'Healthy': 'None'
            };
            
            return {
                name: disease,
                plant: plant,
                treatment: treatments[disease] || 'Consult with a local agricultural expert for specific treatment recommendations.',
                prevention: preventions[disease] || 'Implement general plant health practices including proper spacing and watering.',
                severity: severities[disease] || 'Unknown',
                environmentalImpact: 'This disease can reduce yield by 20-60% if left untreated. Early detection and treatment are crucial.'
            };
        }

        function updateResultsUI(diseaseInfo, confidence) {
            diseaseName.textContent = diseaseInfo.name;
            confidenceText.textContent = `${Math.round(confidence)}%`;
            confidenceFill.style.width = `${confidence}%`;
            plantSpecies.textContent = diseaseInfo.plant;
            severityLevel.textContent = diseaseInfo.severity;
            treatmentInfo.innerHTML = `<p>${diseaseInfo.treatment}</p>`;
            preventionInfo.innerHTML = `<p>${diseaseInfo.prevention}</p>`;
            environmentalInfo.innerHTML = `<p>${diseaseInfo.environmentalImpact}</p>`;
        }

        function addToHistory(result, confidence) {
            const detection = {
                id: Date.now(),
                plant: result.plant,
                disease: result.name,
                confidence: confidence,
                severity: result.severity,
                date: new Date().toISOString()
            };
            
            detectionHistory.unshift(detection);
            
            // Keep only last 50 detections
            if (detectionHistory.length > 50) {
                detectionHistory = detectionHistory.slice(0, 50);
            }
            
            // Save to localStorage
            localStorage.setItem('detectionHistory', JSON.stringify(detectionHistory));
            
            // Update chart
            updateChart();
        }

        // Advanced Features
        async function getWeatherData() {
            try {
                // In a real implementation, this would use a weather API
                // For demo, we'll use mock data
                alert('Weather data: Temperature: 24¬∞C, Humidity: 65%, Rainfall: 2mm. Conditions favorable for plant growth.');
            } catch (error) {
                console.error('Error fetching weather data:', error);
                alert('Unable to fetch weather data at this time.');
            }
        }

        async function getMarketPrices() {
            try {
                // In a real implementation, this would use a market data API
                // For demo, we'll use mock data
                alert('Current market prices:\nTomato: $1.20/kg\nPotato: $0.80/kg\nCorn: $0.60/kg\nWheat: $0.40/kg');
            } catch (error) {
                console.error('Error fetching market prices:', error);
                alert('Unable to fetch market prices at this time.');
            }
        }

        function exportReport() {
            // Create a simple PDF report (in a real app, use a library like jsPDF)
            const reportContent = `
                AgriScan AI Disease Detection Report
                ===================================
                
                Plant: ${plantSpecies.textContent}
                Disease: ${diseaseName.textContent}
                Confidence: ${confidenceText.textContent}
                Severity: ${severityLevel.textContent}
                
                Treatment Recommendations:
                ${treatmentInfo.textContent}
                
                Prevention Tips:
                ${preventionInfo.textContent}
                
                Generated on: ${new Date().toLocaleString()}
            `;
            
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agriscan-report-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Chart initialization
        const ctx = document.getElementById('diseaseChart').getContext('2d');
        let diseaseChart;

        function updateChart() {
            if (diseaseChart) {
                diseaseChart.destroy();
            }
            
            // Process detection history for chart
            const diseaseCounts = {};
            detectionHistory.forEach(detection => {
                if (detection.disease !== 'Healthy') {
                    diseaseCounts[detection.disease] = (diseaseCounts[detection.disease] || 0) + 1;
                }
            });
            
            const labels = Object.keys(diseaseCounts);
            const data = Object.values(diseaseCounts);
            
            diseaseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Detection Frequency',
                        data: data,
                        backgroundColor: 'rgba(46, 125, 50, 0.7)',
                        borderColor: 'rgba(46, 125, 50, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Disease Detection History'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Detections'
                            }
                        }
                    }
                }
            });
        }

        // Chatbot functionality
        function toggleChatbot() {
            chatbotContainer.classList.toggle('chatbot-hidden');
        }

        function sendChatMessage() {
            const message = chatbotInput.value.trim();
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            chatbotInput.value = '';
            
            // Generate and add bot response
            setTimeout(() => {
                const response = generateBotResponse(message);
                addChatMessage(response, 'bot');
            }, 1000);
        }

        function addChatMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            messageElement.textContent = text;
            
            chatbotMessages.appendChild(messageElement);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        function generateBotResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Simple response logic - in a real app, this would use NLP/AI
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return "Hello! I'm your plant health assistant. How can I help you with your plants today?";
            } else if (lowerMessage.includes('tomato') && lowerMessage.includes('blight')) {
                return "Tomato blight is a common fungal disease. For early blight, use copper-based fungicides. For late blight, remove infected plants immediately and use resistant varieties next season.";
            } else if (lowerMessage.includes('treatment') || lowerMessage.includes('cure')) {
                return "Treatment depends on the specific disease. Could you tell me which plant and symptoms you're seeing? Or upload an image for AI analysis.";
            } else if (lowerMessage.includes('prevent') || lowerMessage.includes('avoid')) {
                return "Good practices include crop rotation, proper spacing, watering at the base, and using disease-resistant varieties. Regular monitoring helps catch issues early.";
            } else if (lowerMessage.includes('healthy') || lowerMessage.includes('care')) {
                return "For healthy plants: ensure proper sunlight, water consistently but don't overwater, use balanced fertilizer, and monitor for pests regularly.";
            } else if (lowerMessage.includes('weather')) {
                return "Weather significantly impacts plant diseases. Warm, humid conditions often promote fungal growth. Check the weather feature for current conditions.";
            } else if (lowerMessage.includes('price') || lowerMessage.includes('market')) {
                return "Market prices fluctuate based on supply and demand. Check the market prices feature for current values of various crops.";
            } else {
                return "I understand you're asking about plant health. For specific advice, please describe the plant type and symptoms you're observing, or upload an image for AI analysis.";
            }
        }

        // Initialize chart on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateChart();
            
            // Load any previous detection from localStorage
            if (detectionHistory.length > 0) {
                console.log(`Loaded ${detectionHistory.length} previous detections`);
            }
        });
    </script>
</body>
</html>